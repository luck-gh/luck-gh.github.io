{"title":"电子纸驱动的编写","slug":"项目/电子纸驱动","date":"2018-05-10T06:00:15.000Z","updated":"2018-05-22T10:48:06.377Z","comments":true,"path":"api/articles/项目/电子纸驱动.json","photos":[],"link":"","excerpt":" * “十三五“规划提出大数据概念无疑将推动物联网的进程，互联网+的口号提出将为更多的设备加入网络提供政策支持，绿色环保也在其中，具备超低功耗特性的微控制器也将大展宏图。ST目前一共推出三个超低功耗系列的MCU：STM32L0(Cortex-M0/M0+)、STM32L1（Cortex-M3）、STM32L4(Cortex-M4)。STM32L0系列STM32微控制器让客户能够取得前所未有的低功耗，整合高能效的ARM Cortex®-M0+内核、优化架构、电源管理模式、超低功耗外设、支持节能型USB功能、独有的超低功耗制造工艺。<br>","covers":["https://wx1.sinaimg.cn/mw690/0079ID0Dly1frkatehzeij31kw16oqv8.jpg","https://wx3.sinaimg.cn/mw690/0079ID0Dly1frkavi8ljnj31kw16onph.jpg","https://wx1.sinaimg.cn/mw690/0079ID0Dly1frk8z5elb7j30nd0qgwh7.jpg","https://wx4.sinaimg.cn/mw690/0079ID0Dly1frk8z5c8y6j30g60mc0u8.jpg"],"content":"<p><strong> * “十三五“规划提出大数据概念无疑将推动物联网的进程，互联网+的口号提出将为更多的设备加入网络提供政策支持，绿色环保也在其中，具备超低功耗特性的微控制器也将大展宏图。ST目前一共推出三个超低功耗系列的MCU：STM32L0(Cortex-M0/M0+)、STM32L1（Cortex-M3）、STM32L4(Cortex-M4)。STM32L0系列STM32微控制器让客户能够取得前所未有的低功耗，整合高能效的ARM Cortex®-M0+内核、优化架构、电源管理模式、超低功耗外设、支持节能型USB功能、独有的超低功耗制造工艺。</strong><br><a id=\"more\"></a></p>\n<hr>\n<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><ul>\n<li><p>首先感谢李老师给我提供的这块板子：<code>STM32L0-Discovery</code></p>\n</li>\n<li><p>这次的目的是做出电子纸的驱动，难度不大，毕竟硬件开发板都是集成好的，而且做STM32还有HAL库以及<code>STM32Cube</code>这种东西，相比<code>Exynos4412</code>的开发简单太多了。</p>\n</li>\n</ul>\n<h1 id=\"STM32L0-Discovery\"><a href=\"#STM32L0-Discovery\" class=\"headerlink\" title=\"STM32L0-Discovery\"></a>STM32L0-Discovery</h1><h2 id=\"正面\"><a href=\"#正面\" class=\"headerlink\" title=\"正面\"></a><strong><em>正面</em></strong></h2><p><img src=\"https://wx1.sinaimg.cn/mw690/0079ID0Dly1frkatehzeij31kw16oqv8.jpg\" alt=\"STM32L0-Discovery正面\"></p>\n<h2 id=\"反面\"><a href=\"#反面\" class=\"headerlink\" title=\"反面\"></a><strong><em>反面</em></strong></h2><p><img src=\"https://wx3.sinaimg.cn/mw690/0079ID0Dly1frkavi8ljnj31kw16onph.jpg\" alt=\"STM32L0-Discovery背面\"></p>\n<hr>\n<h1 id=\"前期准备\"><a href=\"#前期准备\" class=\"headerlink\" title=\"前期准备\"></a>前期准备</h1><ul>\n<li>第一步当然是看开发板的用户手册以及电路图，这些文件需要从 <a href=\"www.st.com\">ST官网</a> 去寻找，这里直接给出网址 <a href=\"www.st.com/stm32l0-discovery\">32L0538DISCOVERY</a> (嗯，右上角有中文网页)</li>\n<li>不多BB然后找显示屏的文档，根据开发板的用户手册可以查出显示设备的型号为 <a href=\"http://www.good-display.com/\" target=\"_blank\" rel=\"noopener\">大连佳显电子有限公司</a> 的  “<a href=\"http://www.good-display.cn/products_detail/productId=158.html\" target=\"_blank\" rel=\"noopener\">GDE021A1</a>”  在这个官网里面找到电子纸的用户手册。</li>\n</ul>\n<h2 id=\"板上资源\"><a href=\"#板上资源\" class=\"headerlink\" title=\"板上资源\"></a>板上资源</h2><ul>\n<li>要了解板子上的资源，先看开发板硬件电路图。</li>\n</ul>\n<blockquote>\n<ul>\n<li>从电路图我们可以看出，开发板上都提供了哪些资源，不用多说，ST-Link/V2-1这个是ST官方开发板均具备的调试编程器，另外上面提供了SWD接口，方便你为自己的项目进行编程调试；剩下全部是围绕主角STM32L053C8T6的，板载提供了两颗按键B1(用户可编程按键)、B2（系统复位按键），提供了可编程的两颗LED（LD3、LD4）,以及NFC接口，线性触摸传感器和电子纸显示屏；另外一个就是STM32L系列探索板特有的部分IDD电流检测电路模块。<br>总结， 开发板提供了四类资源：1、编程调试电路；2、最小系统电路；3、扩展接口与板载外设；4、电流检测电路。</li>\n<li>板上一共提供了3颗MCU，正面靠近USB口的应该是调试器ST-Link的，背面两颗，靠近板子底端白纸条编号的一颗就是我们的主角STM32L053C8T6。</li>\n<li>我们看到正反面采用了绿、白色搭配（PCB采用绿底白字），这也是Discovery系列一贯风格。对于扩展接口全部预留出来，共计25×2个PIN，探索板扩展接口采用了标志性的两面针排针风格，如果想保证板子实用时候美观只能准备大量的杜邦线了。根据调试器端两个USB接口形状来看，采用了Mini-USB接口，中间的USB接口是ST-Link的，靠边的一个是用户USB接口，应该是可以挂载USB盘等USB从机设备的。</li>\n</ul>\n</blockquote>\n<h2 id=\"特性总结：\"><a href=\"#特性总结：\" class=\"headerlink\" title=\"特性总结：\"></a>特性总结：</h2><blockquote>\n<ul>\n<li>采用LQFP48封装的<code>STM32L053C8T6</code> MCU,片上具备64KB Flash，8KB RAM;</li>\n<li>板载ST-LINK/V2-1调试器，可通过选择开关设置为独立使用模式，具备SWD编程调试接口，USB支持三种功能，虚拟串口、大容量存储器、调试接口；</li>\n<li>开发板电源支持USB总线供电，或通过外部5V供电，外部应用供电支持3V模式和5V模式。</li>\n<li>板载一个线性触摸传感器，或作为4个触摸按键；</li>\n<li>板载IDD电流检测模块；</li>\n<li>板载2.04寸E-paper display（电子纸显示屏），分辨率为172×72；</li>\n<li>板载4个LED：<br>LD1(红/绿)，用于USB通信状态指示<br>LD2(红)，用于3.3V电源指示<br>另外两个是用户可编程LED，LD3(绿)/LD4(红)</li>\n<li>板载两个实体按键，用户按键（蓝色）和复位按键（黑色）；</li>\n<li>扩展接口25×2，两排，将STM32L053的48个PIN全部引出</li>\n</ul>\n</blockquote>\n<hr>\n<h1 id=\"基本套路\"><a href=\"#基本套路\" class=\"headerlink\" title=\"基本套路\"></a>基本套路</h1><ul>\n<li><p>好了前期的文档准备已经OK了，首先我们再次明确目标，本次的开发就是为了“电子纸”，那么好这里先看看手册怎么说，<img src=\"https://wx1.sinaimg.cn/mw690/0079ID0Dly1frk8z5elb7j30nd0qgwh7.jpg\" alt=\"如图1.1\">从目录我们可以很清晰的寻找到电子纸功能块的介绍<img src=\"https://wx3.sinaimg.cn/mw690/0079ID0Dly1frk8yy0ecdj310i0b3jtd.jpg\" alt=\"如图1.2\">，很显然没什么实际性的意义，现在看硬件电路图，这里找到电子纸与MCU的连接端口<img src=\"https://wx3.sinaimg.cn/mw690/0079ID0Dly1frk8z5f1c2j31040nu780.jpg\" alt=\"如图1.3\">这里我们起码知道了他们之间的通信方式是4线SPI。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SDA_H  HAL_GPIO_WritePin(GPIOB,GPIO_PIN_5,GPIO_PIN_SET);</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SDA_L  HAL_GPIO_WritePin(GPIOB,GPIO_PIN_5,GPIO_PIN_RESET);</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SCLK_H HAL_GPIO_WritePin(GPIOB,GPIO_PIN_3,GPIO_PIN_SET);</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> SCLK_L HAL_GPIO_WritePin(GPIOB,GPIO_PIN_3,GPIO_PIN_RESET);</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> nCS_H  HAL_GPIO_WritePin(GPIOA,GPIO_PIN_15,GPIO_PIN_SET);</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> nCS_L  HAL_GPIO_WritePin(GPIOA,GPIO_PIN_15,GPIO_PIN_RESET);</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> nDC_H  HAL_GPIO_WritePin(GPIOB,GPIO_PIN_11,GPIO_PIN_SET);</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> nDC_L  HAL_GPIO_WritePin(GPIOB,GPIO_PIN_11,GPIO_PIN_RESET);</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> nRST_H HAL_GPIO_WritePin(GPIOB, GPIO_PIN_2,GPIO_PIN_SET);</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> nRST_L HAL_GPIO_WritePin(GPIOB, GPIO_PIN_2,GPIO_PIN_RESET);</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> nBUSY  HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_8)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>这下板子这边的手册以及原理图就看完了，现在转战电子纸这边，首先从目录出发可以看到这边的通信方式很多，不管别的，直接找4线SPI ！<img src=\"https://wx4.sinaimg.cn/mw690/0079ID0Dly1frk8z5c8y6j30g60mc0u8.jpg\" alt=\"如图1.4\"><img src=\"https://wx2.sinaimg.cn/mw690/0079ID0Dly1frk8z5de9rj30gn0l640k.jpg\" alt=\"如图1.5\"><img src=\"https://wx2.sinaimg.cn/mw690/0079ID0Dly1frk8z5f2yej30ip0mc0vc.jpg\" alt=\"如图1.6\">现在找到控制流程图<img src=\"https://wx4.sinaimg.cn/mw690/0079ID0Dly1frk8z5dvkvj30i30mb0v5.jpg\" alt=\"如图1.7\">这个便是这次驱动的核心所在，这边可以看到，发送数据分为两种模式，一种<code>Command</code>一种<code>Data</code>，这两种都是MCU向电子纸发送数据那么又有什么不同呢？我们可以翻阅P17的<code>Command Table</code>这个表格可以直观的体现出<code>Command</code>和<code>Data</code>的区别，<code>Command</code>代表寄存器地址， <code>Data</code>代表模式或者数据设置。认真阅读寄存器功能就是这次任务的重中之重，</p>\n</li>\n</ul>\n<hr>\n<h1 id=\"驱动示例\"><a href=\"#驱动示例\" class=\"headerlink\" title=\"驱动示例\"></a>驱动示例</h1><ul>\n<li>下面就是一些驱动函数<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//复位</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">MyRESET</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\tnRST_L</span><br><span class=\"line\">\tHAL_Delay(<span class=\"number\">100</span>);</span><br><span class=\"line\"> \tnRST_H</span><br><span class=\"line\">  \tHAL_Delay(<span class=\"number\">100</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//繁忙等待</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">READBUSY</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">while</span>(<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">\t  <span class=\"keyword\">if</span>(nBUSY == <span class=\"number\">0</span>) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//发送Command</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SPI4W_WRITECOM</span><span class=\"params\">(<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> INIT_COM)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> TEMPCOM;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> scnt;</span><br><span class=\"line\">\tTEMPCOM=INIT_COM;</span><br><span class=\"line\">\tnCS_H</span><br><span class=\"line\">\tnCS_L </span><br><span class=\"line\">\tnDC_L</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(scnt=<span class=\"number\">0</span>;scnt&lt;<span class=\"number\">8</span>;scnt++) &#123;</span><br><span class=\"line\">\t\tSCLK_L</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(TEMPCOM&amp;<span class=\"number\">0x80</span>)</span><br><span class=\"line\">\t\t\tSDA_H</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\tSDA_L</span><br><span class=\"line\">\t\tSCLK_H  </span><br><span class=\"line\">\t\tTEMPCOM= ( TEMPCOM&lt;&lt;<span class=\"number\">1</span> );</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnCS_H  </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//发送Data</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">SPI4W_WRITEDATA</span><span class=\"params\">(<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> INIT_DATA)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> TEMPCOM;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> scnt;</span><br><span class=\"line\">\tTEMPCOM=INIT_DATA;</span><br><span class=\"line\">\tnCS_H</span><br><span class=\"line\">\tnCS_L</span><br><span class=\"line\">\tnDC_H</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(scnt=<span class=\"number\">0</span>;scnt&lt;<span class=\"number\">8</span>;scnt++) &#123;</span><br><span class=\"line\">\t\tSCLK_L</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(TEMPCOM&amp;<span class=\"number\">0x80</span>)</span><br><span class=\"line\">\t\t\tSDA_H</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\tSDA_L</span><br><span class=\"line\">\t\tSCLK_H  </span><br><span class=\"line\">\t\tTEMPCOM= ( TEMPCOM&lt;&lt;<span class=\"number\">1</span> );</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tnCS_H </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//发送LUT</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">WRITE_LUT</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> i;</span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x32</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">90</span>;i++)</span><br><span class=\"line\">        SPI4W_WRITEDATA(init_data[i]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">INIT_SPD2701</span><span class=\"params\">(<span class=\"keyword\">void</span>)</span> </span>&#123;    </span><br><span class=\"line\">    MyRESET();  <span class=\"comment\">//复位</span></span><br><span class=\"line\">\tREADBUSY();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//退出深度睡眠</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x10</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x00</span>);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//数据输入模式设置</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x11</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x03</span>);\t</span><br><span class=\"line\">\t<span class=\"comment\">//电子纸的X轴起始位置与结束为止的设置</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x44</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x00</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x11</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//电子纸的Y轴起始位置与结束为止的设置</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x45</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x00</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0xAB</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//X轴刷新初始位置</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x4E</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x00</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//Y轴刷新初始位置</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x4F</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x00</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//反馈加强选项</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0xF0</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x1F</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//注册Vcom</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x2C</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0xA0</span>);</span><br><span class=\"line\">\t<span class=\"comment\">//设置边界</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x3C</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x63</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//发送LUT</span></span><br><span class=\"line\">\tWRITE_LUT();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//buf为要显示的数据，根据不同情况大小不同（局部刷新，全局刷新）</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">my_display</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> * buf，<span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> i;</span><br><span class=\"line\">\tREADBUSY();</span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x24</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>;i &lt; size;i++) </span><br><span class=\"line\">\t\tSPI4W_WRITEDATA(buf[i]);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\">//激活显示更新程序</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x21</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x03</span>);</span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x22</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0xc4</span>);</span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x20</span>); </span><br><span class=\"line\"></span><br><span class=\"line\">\tREADBUSY();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"comment\">//关闭电源</span></span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x22</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x03</span>);</span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x10</span>);</span><br><span class=\"line\">\tSPI4W_WRITEDATA(<span class=\"number\">0x01</span>);</span><br><span class=\"line\">\tSPI4W_WRITECOM(<span class=\"number\">0x20</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<hr>\n<h1 id=\"画圆画直线\"><a href=\"#画圆画直线\" class=\"headerlink\" title=\"画圆画直线\"></a>画圆画直线</h1><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//功能：在显存buf里面画圆（圆心半径确定圆）</span></span><br><span class=\"line\"><span class=\"comment\">//x,y：圆心坐标</span></span><br><span class=\"line\"><span class=\"comment\">//R：圆半径</span></span><br><span class=\"line\"><span class=\"comment\">//circle_color：圆内颜色（四灰度 00 01 10 11）</span></span><br><span class=\"line\"><span class=\"comment\">//back_color：圆外颜色 （四灰度 00 01 10 11）（为4时保留之前颜色）</span></span><br><span class=\"line\"><span class=\"comment\">//buf：大小为3096的显存</span></span><br><span class=\"line\"><span class=\"comment\">//size：sizeof(buf);</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">draw_circle</span><span class=\"params\">(<span class=\"keyword\">int</span> x, <span class=\"keyword\">int</span> y, <span class=\"keyword\">int</span> R, <span class=\"keyword\">int</span> circle_color, <span class=\"keyword\">int</span> back_color,<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> *buf,<span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> date = buf[<span class=\"number\">0</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>,j = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(size != <span class=\"number\">3096</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;<span class=\"comment\">//防错</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(i = <span class=\"number\">0</span>;i &lt; (<span class=\"number\">0Xab</span>+<span class=\"number\">1</span>);i++) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (j = <span class=\"number\">0</span>; j &lt; (<span class=\"number\">4</span>*(<span class=\"number\">0x11</span>+<span class=\"number\">1</span>)+<span class=\"number\">1</span>) ;j++) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>((j%<span class=\"number\">4</span> == <span class=\"number\">0</span>)&amp;&amp;(j != <span class=\"number\">0</span>))&#123;</span><br><span class=\"line\">\t\t\t\tbuf[j/<span class=\"number\">4</span> + i*<span class=\"number\">18</span> - <span class=\"number\">1</span>] = date;</span><br><span class=\"line\">\t\t\t\tdate = buf[j/<span class=\"number\">4</span> + i * <span class=\"number\">18</span>]; </span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>(((i - x)*(i - x)+(j - y)*(j - y)) &lt; R*R) &#123;</span><br><span class=\"line\">\t\t\t\tdate &amp;= ~((<span class=\"number\">0x03</span>) &lt;&lt; (<span class=\"number\">6</span>-(j%<span class=\"number\">4</span>)*<span class=\"number\">2</span>));</span><br><span class=\"line\">\t\t\t\tdate |=  ((circle_color&amp;<span class=\"number\">0x03</span>) &lt;&lt; (<span class=\"number\">6</span>-(j%<span class=\"number\">4</span>)*<span class=\"number\">2</span>));</span><br><span class=\"line\">\t\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span> (back_color != <span class=\"number\">4</span>) &#123;</span><br><span class=\"line\">\t\t\t\t\tdate &amp;= ~((<span class=\"number\">0x03</span>) &lt;&lt; (<span class=\"number\">6</span>-(j%<span class=\"number\">4</span>)*<span class=\"number\">2</span>));</span><br><span class=\"line\">\t\t\t\t\tdate |=  ((back_color&amp;<span class=\"number\">0x03</span>) &lt;&lt; (<span class=\"number\">6</span>-(j%<span class=\"number\">4</span>)*<span class=\"number\">2</span>));</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;\t</span><br><span class=\"line\">\t\t&#125;\t</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//功能：在显存buf里面画直线（两点确定直线）</span></span><br><span class=\"line\"><span class=\"comment\">//x1,y1：第一个点</span></span><br><span class=\"line\"><span class=\"comment\">//x2,y2：第二个点</span></span><br><span class=\"line\"><span class=\"comment\">//width：误差范围（直线宽度）</span></span><br><span class=\"line\"><span class=\"comment\">//buf：大小为3096的显存</span></span><br><span class=\"line\"><span class=\"comment\">//size：sizeof(buf);</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">draw_line</span><span class=\"params\">(<span class=\"keyword\">int</span> x1, <span class=\"keyword\">int</span> y1, <span class=\"keyword\">int</span> x2, <span class=\"keyword\">int</span> y2,<span class=\"keyword\">int</span> width , <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> *buf, <span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> date = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> x = <span class=\"number\">0</span>,y = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(size != <span class=\"number\">3096</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;<span class=\"comment\">//防错</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span>(x = <span class=\"number\">0</span>;x &lt; (<span class=\"number\">0Xab</span>+<span class=\"number\">1</span>);x++) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">for</span> (y = <span class=\"number\">0</span>; y &lt; (<span class=\"number\">4</span>*(<span class=\"number\">0x11</span>+<span class=\"number\">1</span>)+<span class=\"number\">1</span>) ;y++) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>((y%<span class=\"number\">4</span> == <span class=\"number\">0</span>)&amp;&amp;(y != <span class=\"number\">0</span>))&#123;</span><br><span class=\"line\">\t\t\t\tbuf[y/<span class=\"number\">4</span> + x*<span class=\"number\">18</span> - <span class=\"number\">1</span>] = date;</span><br><span class=\"line\">\t\t\t\tdate = buf[y/<span class=\"number\">4</span> + x * <span class=\"number\">18</span>]; </span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span>( (((y - y2)*(x1 - x2) &gt; (x - x2)*(y1 - y2)-width/<span class=\"number\">2</span>)&amp;&amp;</span><br><span class=\"line\">\t\t\t     ((y - y2)*(x1 - x2) &lt; (x - x2)*(y1 - y2)+width/<span class=\"number\">2</span>))&amp;&amp;</span><br><span class=\"line\">\t\t\t      (y &gt;= (y1 &lt; y2 ? y1:y2))&amp;&amp;(y &lt;= (y1 &lt; y2 ? y2:y1))&amp;&amp;</span><br><span class=\"line\">\t\t\t      (x &gt;= (x1 &lt; x2 ? x1:x2))&amp;&amp;(x &lt;= (x1 &lt; x2 ? x2:x1)) )</span><br><span class=\"line\">\t\t\t\tdate &amp;= ~((<span class=\"number\">0x03</span>) &lt;&lt; (<span class=\"number\">6</span>-(y%<span class=\"number\">4</span>)*<span class=\"number\">2</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//功能：在显存buf里面画直线（根据一个点、一个角度和一个长度）</span></span><br><span class=\"line\"><span class=\"comment\">//x，y：基准坐标点</span></span><br><span class=\"line\"><span class=\"comment\">//r：线段长度</span></span><br><span class=\"line\"><span class=\"comment\">//angle：偏转角度</span></span><br><span class=\"line\"><span class=\"comment\">//width：误差范围（直线宽度）</span></span><br><span class=\"line\"><span class=\"comment\">//buf：大小为3096的显存</span></span><br><span class=\"line\"><span class=\"comment\">//size：sizeof(buf);</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">count_point</span><span class=\"params\">(<span class=\"keyword\">int</span> x, <span class=\"keyword\">int</span> y,<span class=\"keyword\">int</span> r, <span class=\"keyword\">int</span> angle, <span class=\"keyword\">int</span> width, <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> *buf, <span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> x1 = <span class=\"number\">0</span>,y1 = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(size != <span class=\"number\">3096</span>) <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;<span class=\"comment\">//防错</span></span><br><span class=\"line\">\tx1 = x + r*<span class=\"built_in\">cos</span>(angle*<span class=\"number\">-3.1415926</span>/<span class=\"number\">180</span>);</span><br><span class=\"line\">\ty1 = y + r*<span class=\"built_in\">sin</span>(angle*<span class=\"number\">-3.1415926</span>/<span class=\"number\">180</span>);</span><br><span class=\"line\">\tdraw_line(x,y,x1,y1,width,buf);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h1><ul>\n<li>该探索板跟以往的开发板比，最大的特点就是使用了EPD作为显示器，由于该显示器断电后还可以显示的特点，可以说非常适合用于超低功耗设备的显示器，这样可以定时的更新显示内容，其他时间可以关闭显示设备的供电，另外系统也可以进入超低功耗休眠状态，例如作为电子表的应用。</li>\n<li>另外ARM在不断的推出功能越来越强大的产品设计时候，也注意到来了，随着功能的越来越多越来越强大，开发者花费在学习上的成本就越来越多，因此ARM也在努力找到一种缩减学习成本的方法，让开发者一劳永逸的方法。这也就是MBED推出的重要原因之一吧。由于是刚刚推出不久，相信经过一段时间的发展会越来越适合项目开发使用。</li>\n</ul>\n","categories":[{"name":"电子纸","slug":"电子纸","count":1,"path":"api/categories/电子纸.json"}],"tags":[{"name":"STM32","slug":"STM32","count":1,"path":"api/tags/STM32.json"}]}